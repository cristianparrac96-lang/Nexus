<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus | GoKollect - Portal de gestión</title>
    <link rel="icon" href="img/Logo_GK.png" type="image/png">
    <!-- FUENTES E ICONOS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root {
            --gk-cyan: #00d4ff;
            --gk-magenta: #ff007f;
            --gk-gradient: linear-gradient(135deg, #00d4ff 0%, #ff007f 100%);
            --dark-bg: #020617;
            --glass: rgba(255, 255, 255, 0.03);
            --border-glass: rgba(255, 255, 255, 0.08);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top right, #1e293b, #020617);
            color: #f8fafc;
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
        }

        /* ANIMACIONES */
        .fade-in { animation: fadeIn 0.6s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* SECCIÓN LOGIN */
        #login-section { width: 100%; max-width: 400px; padding: 20px; text-align: center; }
        .login-card {
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(25px);
            border: 1px solid var(--border-glass);
            border-radius: 30px;
            padding: 40px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
        }
        .login-card h2 { font-size: 10px; text-transform: uppercase; letter-spacing: 4px; color: var(--gk-cyan); margin-bottom: 30px; }
        .input-auth { width: 100%; background: rgba(0,0,0,0.4); border: 1px solid var(--border-glass); padding: 15px; border-radius: 12px; color: white; margin-bottom: 15px; box-sizing: border-box; outline: none; }
        .btn-auth { width: 100%; padding: 15px; background: var(--gk-gradient); border: none; border-radius: 12px; color: white; font-weight: 600; text-transform: uppercase; letter-spacing: 2px; cursor: pointer; transition: 0.3s; }

        /* PORTAL PRINCIPAL (OCULTO) */
        #main-portal { display: none; width: 100%; align-self: flex-start; }

        /* BUSCADOR CENTRAL */
        #search-portal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; width: 100%; max-width: 600px; transition: all 0.7s cubic-bezier(0.4, 0, 0.2, 1); z-index: 100;
        }
        #search-portal.minimized { position: absolute; top: 40px; transform: translate(-50%, 0); max-width: 450px; }
        .search-box { background: var(--glass); backdrop-filter: blur(10px); border: 1px solid var(--border-glass); padding: 15px 25px; border-radius: 50px; display: flex; align-items: center; box-shadow: 0 0 30px rgba(0, 212, 255, 0.1); }
        .search-box i { color: var(--gk-cyan); margin-right: 15px; font-size: 18px; }
        .search-box input { background: transparent; border: none; color: white; font-size: 18px; width: 100%; outline: none; }

        .logo-portal { height: 60px; mix-blend-mode: lighten; }

        /* DASHBOARD */
        .main-container { max-width: 1100px; margin: 260px auto 50px auto; padding: 0 20px; display: none; }
        .glass-card { background: var(--glass); backdrop-filter: blur(12px); border: 1px solid var(--border-glass); padding: 30px; border-radius: 24px; margin-bottom: 30px; }
        .section-title { font-size: 12px; font-weight: 600; color: var(--gk-cyan); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 20px; border-left: 3px solid var(--gk-magenta); padding-left: 10px; }

        .input-group { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; align-items: flex-end; }
        .input-field { display: flex; flex-direction: column; flex: 1; min-width: 180px; }
        label { font-size: 9px; font-weight: 600; color: #94a3b8; margin-bottom: 8px; text-transform: uppercase; display: flex; align-items: center; gap: 6px; }
        input { background: rgba(0,0,0,0.3); border: 1px solid var(--border-glass); padding: 12px; border-radius: 12px; color: white; font-size: 14px; }

        .btn-neon { background: var(--gk-gradient); color: white; border: none; padding: 12px 25px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.3s; text-transform: uppercase; font-size: 11px; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 8px 15px rgba(255, 0, 127, 0.2); }
        .btn-neon:hover { transform: translateY(-2px); box-shadow: 0 12px 20px rgba(255, 0, 127, 0.4); }
        #btn-sync { display: none; width: 100%; margin-top: 15px; background: #2563eb; }

        /* DOCUMENTO PDF */
        .document-page { background: white; color: #1a2a3a; padding: 20mm; margin-top: 40px; border-radius: 12px; width: 215.9mm; min-height: 279.4mm; margin-inline: auto; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .header-container { border-bottom: 2px solid #1a2a3a; padding-bottom: 20px; margin-bottom: 30px; display: flex; flex-direction: column; align-items: center; }
        .logo-row-doc { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .logo-img-doc { max-height: 50px; max-width: 160px; object-fit: contain; mix-blend-mode: multiply; }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 35px; padding: 20px; border: 1px solid #e2e8f0; border-radius: 12px; background-color: #fcfcfc; }
        .info-item { display: flex; flex-direction: column; gap: 4px; }
        .info-label-doc { font-weight: 600; color: #64748b; font-size: 10px; text-transform: uppercase; }
        .info-value-doc { font-size: 14px; color: #1a2a3a; font-weight: 500; }

        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th { padding: 10px; border-bottom: 1px solid #e2e8f0; color: #64748b; font-size: 9px; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; text-align: center; }
        .fila-totales { background-color: #f8fafc !important; font-weight: bold; font-size: 13px; border-top: 2px solid #1a2a3a; }

        @media print {
            body { background: white; display: block; }
            .no-print, #search-portal, #login-section, .action-col { display: none !important; }
            .document-page { box-shadow: none; margin: 0; width: 100%; padding: 10mm; border-radius: 0; }
        }
    </style>
</head>
<body>

    <!-- PORTAL DE ACCESO (LOGIN) -->
    <section id="login-section" class="fade-in">
        <div class="login-card">
            <div style="display:flex; justify-content: center; gap: 15px; margin-bottom: 15px;">
                <img src="img/Logo_GK.png" style="height: 45px; mix-blend-mode: lighten;">
                <img src="img/Logo_AF.png" style="height: 45px; mix-blend-mode: lighten;">
            </div>
            <h2>Nexus Terminal de Acceso</h2>
            <input type="text" id="user" class="input-auth" placeholder="USERNAME">
            <input type="password" id="pass" class="input-auth" placeholder="PASSWORD">
            <button class="btn-auth" onclick="validarLogin()">Protocolo iniciado</button>
            <p id="error-login" style="color:var(--gk-magenta); font-size: 10px; margin-top: 15px; visibility: hidden;">ACCESO DENEGADO - CREDENCIALES INCORRECTAS</p>
        </div>
    </section>

    <!-- INTERFAZ OPERATIVA NEXUS -->
    <main id="main-portal">
        <div id="search-portal">
            <div class="logo-row no-print" style="justify-content: center; gap: 40px; margin-bottom: 30px;">
                <img src="img/Logo_GK.png" class="logo-portal">
                <img src="img/Logo_AF.png" class="logo-portal">
            </div>
            <div class="search-box">
                <i class="fa-solid fa-satellite-dish fa-spin"></i>
                <input type="text" id="main-search" placeholder="ESCANEAR DOCUMENTO PARA LOCALIZAR CLIENTE..." onkeypress="if(event.key==='Enter') iniciarBusqueda()">
            </div>
            <p id="search-msg" style="font-size: 11px; color: var(--gk-cyan); margin-top: 15px; letter-spacing: 1px;"></p>
        </div>

        <div class="main-container" id="main-content">
            <!-- PANEL DE CONTROL -->
            <div id="edit-module" class="glass-card fade-in">
                <div class="section-title"><i class="fa-solid fa-microchip"></i> Panel de Control del Acuerdo</div>
                <div class="input-group">
                    <div class="input-field"><label><i class="fa-solid fa-user"></i> Nombre Cliente</label><input type="text" id="inNombre" oninput="actualizarEncabezado(); detectarCambio()"></div>
                    <div class="input-field"><label><i class="fa-solid fa-briefcase"></i> Fondo</label><input type="text" id="inFondo" oninput="actualizarEncabezado(); detectarCambio()"></div>
                    <div class="input-field"><label><i class="fa-solid fa-sack-dollar"></i> Deuda Total</label><input type="number" id="genMonto" oninput="detectarCambio()"></div>
                </div>
                <div class="input-group" style="border-bottom: 1px solid var(--border-glass); padding-bottom: 20px;">
                    <div class="input-field"><label><i class="fa-solid fa-list-ol"></i> Nro Cuotas</label><input type="number" id="genCuotas" oninput="detectarCambio()"></div>
                    <div class="input-field"><label><i class="fa-solid fa-calendar-days"></i> Fecha Inicio</label><input type="date" id="genFecha" oninput="detectarCambio()"></div>
                    <button class="btn-neon" onclick="generarPlan()"><i class="fa-solid fa-bolt"></i> Re-Calcular Plan</button>
                </div>

                <div style="padding-top: 20px;">
                    <label style="color: var(--gk-magenta); display: block; margin-bottom: 15px; font-size: 10px; font-weight: bold;">EDITOR DE CUOTA SELECCIONADA:</label>
                    <div class="input-group">
                        <input type="hidden" id="editIndex">
                        <div class="input-field"><label><i class="fa-solid fa-calendar-check"></i> Fecha Pactada</label><input type="date" id="fAc"></div>
                        <div class="input-field"><label><i class="fa-solid fa-money-bill-wave"></i> Valor Cuota</label><input type="number" id="vAc"></div>
                        <div class="input-field"><label><i class="fa-solid fa-clock-rotate-left"></i> Fecha Pago Real</label><input type="date" id="fRe"></div>
                        <div class="input-field"><label><i class="fa-solid fa-hand-holding-dollar"></i> Valor Recibido</label><input type="number" id="vRe"></div>
                        <button class="btn-neon" onclick="guardarCambios()"><i class="fa-solid fa-scale-balanced"></i> Equilibrar</button>
                    </div>
                </div>
                <button id="btn-sync" class="btn-neon" onclick="guardarEnNube()"><i class="fa-solid fa-cloud-arrow-up"></i> Sincronizar en la Nube</button>
            </div>

            <!-- DOCUMENTO FINAL -->
            <div class="document-page fade-in">
                <header class="header-container">
                    <div class="logo-row-doc">
                        <img src="img/Logo_GK.png" class="logo-img-doc">
                        <img src="img/Logo_AF.png" class="logo-img-doc">
                    </div>
                    <div class="header-title"><h1>INFORMACIÓN DE ACUERDO DE PAGO</h1></div>
                </header>
                <div class="info-grid">
                    <div class="info-item"><span class="info-label-doc">Nro. Documento</span><div class="info-value-doc" id="outDoc">---</div></div>
                    <div class="info-item"><span class="info-label-doc">Fondo de Origen</span><div class="info-value-doc" id="outFondo">---</div></div>
                    <div class="info-item"><span class="info-label-doc">Nombre del Cliente</span><div class="info-value-doc" id="outNombre">---</div></div>
                    <div class="info-item"><span class="info-label-doc">Fecha de Emisión</span><div class="info-value-doc" id="outEmision">---</div></div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th rowspan="2" style="width:20px">#</th>
                            <th colspan="3" style="background:#f8fafc">Acuerdo</th>
                            <th colspan="3" style="background:#f0fdf4">Recaudo</th>
                            <th rowspan="2" class="action-col no-print">Acción</th>
                        </tr>
                        <tr><th>Fecha</th><th>Valor</th><th>Ref.</th><th>Fecha</th><th>Valor Received</th><th>Días Dif.</th></tr>
                    </thead>
                    <tbody id="tablaCuerpo"></tbody>
                    <tfoot id="tablaTotales"></tfoot>
                </table>
                <button class="btn-neon no-print" onclick="window.print()" style="width:100%; margin-top:30px; background:var(--dark-bg); border:1px solid var(--gk-cyan);"><i class="fa-solid fa-file-pdf"></i> Generar Reporte PDF</button>
                <button class="btn-neon no-print" onclick="location.reload()" style="width:100%; margin-top:10px; background:transparent; border:none; color:#64748b;"><i class="fa-solid fa-magnifying-glass"></i> Nueva Búsqueda</button>
            </div>
        </div>
    </main>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAtCfbyanD34rsy_7sVaagDnzn4idWtjfk",
            authDomain: "cobranzas-gk.firebaseapp.com",
            databaseURL: "https://cobranzas-gk-default-rtdb.firebaseio.com",
            projectId: "cobranzas-gk",
            storageBucket: "cobranzas-gk.firebasestorage.app",
            messagingSenderId: "172059679640",
            appId: "1:172059679640:web:7c55b13a678457c88729ed"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- LOGIN TEMPORAL ---
        window.validarLogin = function() {
            const u = document.getElementById('user').value;
            const p = document.getElementById('pass').value;
            if(u === "Admin" && p === "123") {
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('main-portal').style.display = 'block';
                document.body.style.alignItems = 'flex-start';
                document.body.style.justifyContent = 'flex-start';
            } else {
                const err = document.getElementById('error-login');
                err.style.visibility = 'visible';
                setTimeout(() => err.style.visibility = 'hidden', 3000);
            }
        };

        // --- LÓGICA DE NEGOCIO ---
        window.cuotas = [];
        window.DEUDA_TOTAL = 0;
        const hoy = new Date();
        const moneda = new Intl.NumberFormat('es-CO', {style:'currency', currency:'COP', minimumFractionDigits:0});
        
        document.getElementById('outEmision').innerText = hoy.toLocaleDateString('es-CO', {day:'2-digit', month:'2-digit', year:'numeric'});

        window.iniciarBusqueda = function() {
            const doc = document.getElementById('main-search').value;
            if(!doc) return;
            document.getElementById('search-msg').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ESCANEARNDO...';

            get(child(ref(db), `clientes/${doc}`)).then((snapshot) => {
                document.getElementById('search-portal').classList.add('minimized');
                document.getElementById('main-content').style.display = 'block';

                if (snapshot.exists()) {
                    const data = snapshot.val();
                    document.getElementById('inNombre').value = data.nombre;
                    document.getElementById('inFondo').value = data.fondo;
                    document.getElementById('genMonto').value = data.deudaTotal;
                    document.getElementById('genCuotas').value = data.cuotas.length;
                    document.getElementById('genFecha').value = data.cuotas[0].fechaAc;
                    window.DEUDA_TOTAL = data.deudaTotal;
                    window.cuotas = data.cuotas;
                    actualizarEncabezado();
                    renderizarTabla();
                    document.getElementById('search-msg').innerText = "REGISTRO LOCALIZADO.";
                } else {
                    document.getElementById('search-msg').innerText = "NUEVO REGISTRO.";
                    window.cuotas = [];
                    renderizarTabla();
                }
            });
        };

        window.actualizarEncabezado = function() {
            document.getElementById('outDoc').innerText = document.getElementById('main-search').value;
            document.getElementById('outNombre').innerText = document.getElementById('inNombre').value.toUpperCase();
            document.getElementById('outFondo').innerText = document.getElementById('inFondo').value.toUpperCase();
        };

        window.detectarCambio = function() { document.getElementById('btn-sync').style.display = 'flex'; };

        function ajustarDiaHabil(fecha) {
            let d = fecha.getDay();
            if (d === 0) fecha.setDate(fecha.getDate() - 2); 
            else if (d === 6) fecha.setDate(fecha.getDate() - 1);
            return fecha;
        }

        window.generarPlan = function() {
            window.DEUDA_TOTAL = parseFloat(document.getElementById('genMonto').value);
            const num = parseInt(document.getElementById('genCuotas').value);
            const startStr = document.getElementById('genFecha').value;
            if(!window.DEUDA_TOTAL || !num || !startStr) return;

            window.cuotas = [];
            const baseDate = new Date(startStr + "T00:00:00");
            const diaOriginal = baseDate.getDate();
            const valorBase = Math.floor(window.DEUDA_TOTAL / num);
            const residuo = window.DEUDA_TOTAL % num;

            for(let i=0; i<num; i++) {
                let d = new Date(baseDate.getFullYear(), baseDate.getMonth() + i, 1);
                let ultimoDiaMes = new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
                let diaFinal = Math.min(diaOriginal, ultimoDiaMes);
                let fechaPactada = ajustarDiaHabil(new Date(d.getFullYear(), d.getMonth(), diaFinal));
                window.cuotas.push({
                    fechaAc: fechaPactada.toISOString().split('T')[0],
                    valorAc: (i === num - 1) ? (valorBase + residuo) : valorBase,
                    manual: false, fechaReal: "", valorReal: 0
                });
            }
            detectarCambio(); actualizarEncabezado(); renderizarTabla();
        };

        window.editar = function(i) {
            const c = window.cuotas[i];
            document.getElementById('editIndex').value = i;
            document.getElementById('fAc').value = c.fechaAc;
            document.getElementById('vAc').value = c.valorAc;
            document.getElementById('fRe').value = c.fechaReal;
            document.getElementById('vRe').value = c.valorReal;
        };

        window.guardarCambios = function() {
            const idx = parseInt(document.getElementById('editIndex').value);
            window.DEUDA_TOTAL = parseFloat(document.getElementById('genMonto').value);
            window.cuotas[idx].fechaAc = document.getElementById('fAc').value;
            window.cuotas[idx].valorAc = parseFloat(document.getElementById('vAc').value);
            window.cuotas[idx].manual = true; 
            window.cuotas[idx].fechaReal = document.getElementById('fRe').value;
            window.cuotas[idx].valorReal = parseFloat(document.getElementById('vRe').value || 0);

            let sumaManuales = 0; let autos = [];
            window.cuotas.forEach((c, i) => { if(c.manual) sumaManuales += c.valorAc; else autos.push(i); });
            if (autos.length > 0) {
                let saldo = window.DEUDA_TOTAL - sumaManuales;
                let val = Math.floor(saldo / autos.length);
                let res = saldo % autos.length;
                autos.forEach((pos, i) => { window.cuotas[pos].valorAc = (i === autos.length-1) ? (val+res) : val; });
            }
            detectarCambio(); renderizarTabla();
        };

        function renderizarTabla() {
            const tbody = document.getElementById('tablaCuerpo');
            tbody.innerHTML = ""; let s1 = 0, s2 = 0;
            window.cuotas.forEach((c, i) => {
                s1 += c.valorAc; s2 += c.valorReal;
                const fAc = new Date(c.fechaAc + "T00:00:00");
                let diff = "---";
                if(c.fechaReal) {
                    const d = Math.round((new Date(c.fechaReal + "T00:00:00") - fAc) / 86400000);
                    diff = d > 0 ? `<span style="color:#e11d48;font-weight:bold">+${d}</span>` : `<span style="color:#059669;font-weight:bold">${d}</span>`;
                } else if (fAc < hoy) {
                    diff = `<span style="color:#e11d48;font-weight:bold">+${Math.round((hoy-fAc)/86400000)}</span>`;
                } else { diff = `<span style="color:#2563eb;font-weight:bold">Vigente</span>`; }

                tbody.innerHTML += `
                    <tr>
                        <td>${i+1}</td>
                        <td>${c.fechaAc.split('-').reverse().join('/')}</td>
                        <td>${moneda.format(c.valorAc)}</td>
                        <td>Cuota ${i+1}</td>
                        <td>${c.fechaReal ? c.fechaReal.split('-').reverse().join('/') : '<span style="color:#d97706;font-weight:bold;">PENDIENTE</span>'}</td>
                        <td>${moneda.format(c.valorReal)}</td>
                        <td>${diff}</td>
                        <td class="action-col no-print"><button onclick="editar(${i})" style="background:#334155;color:white;padding:4px 8px;border-radius:6px;border:none;cursor:pointer"><i class="fa-solid fa-pen-to-square"></i></button></td>
                    </tr>`;
            });
            document.getElementById('tablaTotales').innerHTML = `<tr class="fila-totales"><td colspan="2" style="text-align:right">SALDO TOTAL</td><td>${moneda.format(s1)}</td><td colspan="2"></td><td>${moneda.format(s2)}</td><td colspan="2"></td></tr>`;
        }

        window.guardarEnNube = function() {
            const doc = document.getElementById('main-search').value;
            const data = { doc, nombre: document.getElementById('inNombre').value, fondo: document.getElementById('inFondo').value, deudaTotal: parseFloat(document.getElementById('genMonto').value), cuotas: window.cuotas };
            set(ref(db, 'clientes/' + doc), data).then(() => {
                alert("Protocolo de Sincronización Nexus Finalizado.");
                document.getElementById('btn-sync').style.display = 'none';
            });
        };
    </script>
</body>
</html>